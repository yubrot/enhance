# Post-Step 11: Interim Changes Before Step 12

Refactoring and prerequisite work done between Step 11 (DML Operations) and Step 12 (Sort & Aggregation).

## Catalog Cache Introduction

Planning and execution previously required async catalog I/O on every metadata lookup — the planner had to be async solely because of catalog access. `CatalogCache` (per-database, long-lived in-memory copy of table/column metadata) and `CatalogSnapshot` (per-statement, synchronous lookup interface) were introduced to decouple metadata reads from heap page I/O. This makes the planner synchronous and prepares for WAL where catalog reads during recovery must not trigger additional I/O. `TxId::FROZEN` was also registered as `Committed` at `TransactionManager` construction time, since catalog cache entries use FROZEN as their xmin and it needed uniform visibility handling.

## Hint Bit Propagation

Previously deferred from Steps 10 and 11. `check_visibility` now returns a `Visibility` struct carrying newly resolved hint bits as side-information. `scan_visible_page` uses a two-pass approach: a read pass collects visible rows and pending hints, then a conditional write-back pass applies them. The write pass is skipped when all hint bits are already set. This is a prerequisite for WAL (Step 13) and VACUUM (Step 15).

## Engine / Session Layer Restructuring

The `db` module previously contained both infrastructure (buffer pool, transaction manager, catalog, heap operations) and business logic (SQL statement handling, transaction flow). A series of refactorings separated these concerns into distinct layers:

- **Session extraction**: `Session` moved from `src/db/` to `src/session.rs` as a top-level module, establishing the layering `server → session → engine`.
- **Database → Engine rename**: With Session extracted, the remaining infrastructure was renamed to `Engine`/`engine` to better reflect its storage engine role.
- **CatalogStore absorption**: `CatalogStore` (catalog heap I/O orchestration) and `CatalogCache` were absorbed directly into Engine, eliminating wrapper types that served single call sites. `CatalogError` was removed entirely, distributing its variants to `EngineError` and `ExecutorError`.
- **ExecContext realignment**: The concrete `ExecContextImpl` was replaced with a thin `ExecutionPoint` holding a single `Arc<Engine>`, moved from the executor module to the engine module. The `ExecContext` trait remains in executor (consumer side).
- **Naming consolidation**: `CatalogSnapshot` was shortened to `Catalog` (the primary interface for planner).

## Test Helper Consolidation

Duplicated test helpers scattered across modules were extracted into per-layer `tests` modules (`sql::tests`, `catalog::tests`, `executor::tests`, `engine::tests`) with `test_pool()` helpers and a `test_` naming convention, making it easier to add new tests and maintain shared setup functions.
